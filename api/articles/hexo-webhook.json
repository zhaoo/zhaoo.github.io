{"title":"Hexo - 自动部署博客","slug":"hexo-webhook","date":"2021-08-29T12:18:59.000Z","updated":"2021-08-29T12:56:57.679Z","comments":true,"path":"api/articles/hexo-webhook.json","realPath":"/2021/08/29/hexo-webhook/","excerpt":"基于 GitHub-Webhooks 自动拉取并部署博客。","covers":["https://pic.izhaoo.com/20210829204722.jpg","https://pic.izhaoo.com/20210829204907.jpg","https://pic.izhaoo.com/20210829205136.jpg","https://pic.izhaoo.com/20210829205527.jpg"],"cover":"https://pic.izhaoo.com/20210628213000.jpg","content":"<p>基于 GitHub-Webhooks 自动拉取并部署博客。</p>\n<span id=\"more\"></span>\n\n<p>兆兆博客部署在宝塔面板上，每次部署时都要登录面板、上传文件，贼麻烦。燃鹅每次都忍了…终于有一天，忍无可忍了！</p>\n<p>比较方便的方式可以通过 GitHub-Webhooks 设置钩子，在向 GitHub 远程仓库提交代码时，使用 webhook 向服务器发送请求，自动拉取代码更新博客。</p>\n<p>在服务器的 <code>webroot</code> 目录下新建两个文件：</p>\n<pre><code class=\"javascript\">// webhook.js\n\nconst http = require(&#39;http&#39;);\nconst util = require(&#39;util&#39;);\nconst child_process = require(&#39;child_process&#39;);\n\nconst exec = util.promisify(child_process.exec);\nconst port = 3000;  //配置端口\nconst host = &#39;localhost&#39;;  //配置域名\nconst matchUrl = &#39;/webhook&#39;;  //配置路由\n\nconst server = http\n  .createServer(async (request, response) =&gt; &#123;\n    try &#123;\n      const url = request.url;\n      if (url === matchUrl) &#123;\n        await exec(&#39;sh webhook.sh&#39;);  //执行当前目录下的脚本\n        response.write(&#39;Hexo webhook executed successfully&#39;);\n        response.end();\n      &#125; else &#123;\n        response.write(`Hexo webhook running at: http://$&#123;host&#125;:$&#123;port&#125;$&#123;matchUrl&#125;`);\n        response.end();\n      &#125;\n    &#125; catch (e) &#123;\n      console.error(e);\n    &#125;\n  &#125;)\n  .listen(port, host, () =&gt; &#123;\n    console.log(`Hexo webhook running at: http://$&#123;host&#125;:$&#123;port&#125;$&#123;matchUrl&#125;`);\n  &#125;);</code></pre>\n<pre><code class=\"sh\"># webhook.sh\n#!/usr/bin/env bash\n\nrm -rf ~/www/wwwroot/zhaoo/*\ncd ~/www/wwwroot/zhaoo/\ngit pull https://github.com/zhaoo/zhaoo.github.io.git</code></pre>\n<p>在宝塔面板的软件商店中安装 <em>PM2管理器</em>，运行 JavaScript 脚本：</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829204722.jpg\"  ><span class=\"image-caption\">配置 PM2</span></p>\n<p>现在脚本是运行在 <code>http://localhost:3000</code> 下，外网无法访问，使用我们需要配置一个反向代理：</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829204907.jpg\"  ><span class=\"image-caption\">配置反向代理</span></p>\n<p>默认是整个域名进行转发，会导致博客无法访问，所以需要修改下 Nginx 配置，只转发 <code>/webhook</code> 路由。</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829205136.jpg\"  ><span class=\"image-caption\">配置 Nginx</span></p>\n<p>现在访问一下 <code>https://www.izhaoo.com/webhook/</code>，successfully！现在只需访问一次该 URL，服务器便会自动从 GitHub 拉取代码并更新博客。</p>\n<p>最后只需要在 GitHub 配置一下 Webhooks 即可，向 GitHub 推代码时会自动向服务器发送请求。</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829205527.jpg\"  ><span class=\"image-caption\">配置 Webhooks</span></p>\n","more":"<p>兆兆博客部署在宝塔面板上，每次部署时都要登录面板、上传文件，贼麻烦。燃鹅每次都忍了…终于有一天，忍无可忍了！</p>\n<p>比较方便的方式可以通过 GitHub-Webhooks 设置钩子，在向 GitHub 远程仓库提交代码时，使用 webhook 向服务器发送请求，自动拉取代码更新博客。</p>\n<p>在服务器的 <code>webroot</code> 目录下新建两个文件：</p>\n<pre><code class=\"javascript\">// webhook.js\n\nconst http = require(&#39;http&#39;);\nconst util = require(&#39;util&#39;);\nconst child_process = require(&#39;child_process&#39;);\n\nconst exec = util.promisify(child_process.exec);\nconst port = 3000;  //配置端口\nconst host = &#39;localhost&#39;;  //配置域名\nconst matchUrl = &#39;/webhook&#39;;  //配置路由\n\nconst server = http\n  .createServer(async (request, response) =&gt; &#123;\n    try &#123;\n      const url = request.url;\n      if (url === matchUrl) &#123;\n        await exec(&#39;sh webhook.sh&#39;);  //执行当前目录下的脚本\n        response.write(&#39;Hexo webhook executed successfully&#39;);\n        response.end();\n      &#125; else &#123;\n        response.write(`Hexo webhook running at: http://$&#123;host&#125;:$&#123;port&#125;$&#123;matchUrl&#125;`);\n        response.end();\n      &#125;\n    &#125; catch (e) &#123;\n      console.error(e);\n    &#125;\n  &#125;)\n  .listen(port, host, () =&gt; &#123;\n    console.log(`Hexo webhook running at: http://$&#123;host&#125;:$&#123;port&#125;$&#123;matchUrl&#125;`);\n  &#125;);</code></pre>\n<pre><code class=\"sh\"># webhook.sh\n#!/usr/bin/env bash\n\nrm -rf ~/www/wwwroot/zhaoo/*\ncd ~/www/wwwroot/zhaoo/\ngit pull https://github.com/zhaoo/zhaoo.github.io.git</code></pre>\n<p>在宝塔面板的软件商店中安装 <em>PM2管理器</em>，运行 JavaScript 脚本：</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829204722.jpg\"  ><span class=\"image-caption\">配置 PM2</span></p>\n<p>现在脚本是运行在 <code>http://localhost:3000</code> 下，外网无法访问，使用我们需要配置一个反向代理：</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829204907.jpg\"  ><span class=\"image-caption\">配置反向代理</span></p>\n<p>默认是整个域名进行转发，会导致博客无法访问，所以需要修改下 Nginx 配置，只转发 <code>/webhook</code> 路由。</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829205136.jpg\"  ><span class=\"image-caption\">配置 Nginx</span></p>\n<p>现在访问一下 <code>https://www.izhaoo.com/webhook/</code>，successfully！现在只需访问一次该 URL，服务器便会自动从 GitHub 拉取代码并更新博客。</p>\n<p>最后只需要在 GitHub 配置一下 Webhooks 即可，向 GitHub 推代码时会自动向服务器发送请求。</p>\n<p><img  src=\"https://pic.izhaoo.com/20210829205527.jpg\"  ><span class=\"image-caption\">配置 Webhooks</span></p>","categories":[{"name":"前端","path":"api/categories/前端.json"}],"tags":[{"name":"Hexo","path":"api/tags/Hexo.json"},{"name":"前端","path":"api/tags/前端.json"}]}